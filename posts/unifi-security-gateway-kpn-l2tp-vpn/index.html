<!DOCTYPE html><html lang="en" ><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8"><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"><meta name="theme" content="Chirpy v2.7.1"><meta name="generator" content="Jekyll v4.2.0" /><meta property="og:title" content="Unifi Security Gateway (USG) met KPN L2TP VPN" /><meta name="author" content="Henk van Achterberg" /><meta property="og:locale" content="en_US" /><meta name="description" content="Inleiding" /><meta property="og:description" content="Inleiding" /><link rel="canonical" href="https://www.vanachterberg.org/usg-kpn-ftth/posts/unifi-security-gateway-kpn-l2tp-vpn/" /><meta property="og:url" content="https://www.vanachterberg.org/usg-kpn-ftth/posts/unifi-security-gateway-kpn-l2tp-vpn/" /><meta property="og:site_name" content="USG en KPN" /><meta property="og:type" content="article" /><meta property="article:published_time" content="2021-01-18T15:00:00+01:00" /><meta name="twitter:card" content="summary" /><meta property="twitter:title" content="Unifi Security Gateway (USG) met KPN L2TP VPN" /><meta name="twitter:site" content="@coolhva" /><meta name="twitter:creator" content="@Henk van Achterberg" /><meta name="google-site-verification" content="wNFG3DLh0fhsZql0ooCpAUH8yhrA87d4RMHFrG9QNDs" /> <script type="application/ld+json"> {"description":"Inleiding","url":"https://www.vanachterberg.org/usg-kpn-ftth/posts/unifi-security-gateway-kpn-l2tp-vpn/","@type":"BlogPosting","headline":"Unifi Security Gateway (USG) met KPN L2TP VPN","dateModified":"2021-01-18T19:54:03+01:00","datePublished":"2021-01-18T15:00:00+01:00","mainEntityOfPage":{"@type":"WebPage","@id":"https://www.vanachterberg.org/usg-kpn-ftth/posts/unifi-security-gateway-kpn-l2tp-vpn/"},"author":{"@type":"Person","name":"Henk van Achterberg"},"@context":"https://schema.org"}</script><title>Unifi Security Gateway (USG) met KPN L2TP VPN | USG en KPN</title><link rel="shortcut icon" href="/usg-kpn-ftth/assets/img/favicons/favicon.ico" type="image/x-icon"><link rel="icon" href="/usg-kpn-ftth/assets/img/favicons/favicon.ico" type="image/x-icon"><link rel="apple-touch-icon" href="/usg-kpn-ftth/assets/img/favicons/apple-icon.png"><link rel="apple-touch-icon" href="/usg-kpn-ftth/assets/img/favicons/apple-icon-precomposed.png"><link rel="apple-touch-icon" sizes="57x57" href="/usg-kpn-ftth/assets/img/favicons/apple-icon-57x57.png"><link rel="apple-touch-icon" sizes="60x60" href="/usg-kpn-ftth/assets/img/favicons/apple-icon-60x60.png"><link rel="apple-touch-icon" sizes="72x72" href="/usg-kpn-ftth/assets/img/favicons/apple-icon-72x72.png"><link rel="apple-touch-icon" sizes="76x76" href="/usg-kpn-ftth/assets/img/favicons/apple-icon-76x76.png"><link rel="apple-touch-icon" sizes="114x114" href="/usg-kpn-ftth/assets/img/favicons/apple-icon-114x114.png"><link rel="apple-touch-icon" sizes="120x120" href="/usg-kpn-ftth/assets/img/favicons/apple-icon-120x120.png"><link rel="apple-touch-icon" sizes="144x144" href="/usg-kpn-ftth/assets/img/favicons/apple-icon-144x144.png"><link rel="apple-touch-icon" sizes="152x152" href="/usg-kpn-ftth/assets/img/favicons/apple-icon-152x152.png"><link rel="apple-touch-icon" sizes="180x180" href="/usg-kpn-ftth/assets/img/favicons/apple-icon-180x180.png"><link rel="icon" type="image/png" sizes="192x192" href="/usg-kpn-ftth/assets/img/favicons/android-icon-192x192.png"><link rel="icon" type="image/png" sizes="32x32" href="/usg-kpn-ftth/assets/img/favicons/favicon-32x32.png"><link rel="icon" type="image/png" sizes="96x96" href="/usg-kpn-ftth/assets/img/favicons/favicon-96x96.png"><link rel="icon" type="image/png" sizes="16x16" href="/usg-kpn-ftth/assets/img/favicons/favicon-16x16.png"><link rel="manifest" href="/usg-kpn-ftth/assets/img/favicons/manifest.json"><meta name='msapplication-config' content='/usg-kpn-ftth/assets/img/favicons/browserconfig.xml'><meta name="msapplication-TileColor" content="#ffffff"><meta name="msapplication-TileImage" content="/usg-kpn-ftth/assets/img/favicons/ms-icon-144x144.png"><meta name="theme-color" content="#ffffff"><link rel="preconnect" href="https://fonts.gstatic.com" crossorigin="anonymous"><link rel="dns-prefetch" href="https://fonts.gstatic.com"><link rel="preconnect" href="https://www.google-analytics.com" crossorigin="use-credentials"><link rel="dns-prefetch" href="https://www.google-analytics.com"><link rel="preconnect" href="https://www.googletagmanager.com" crossorigin="anonymous"><link rel="dns-prefetch" href="https://www.googletagmanager.com"><link rel="preconnect" href="cdn.jsdelivr.net"><link rel="dns-prefetch" href="cdn.jsdelivr.net"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4.0.0/dist/css/bootstrap.min.css" integrity="sha256-LA89z+k9fjgMKQ/kq4OO2Mrf8VltYml/VES+Rg0fh20=" crossorigin="anonymous"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@5.11.2/css/all.min.css" integrity="sha256-+N4/V/SbAFiW1MPBCXnfnP9QSN3+Keu+NlB+0ev/YKQ=" crossorigin="anonymous"><link rel="preload" href="/usg-kpn-ftth/assets/css/post.css" as="style"><link rel="stylesheet" href="/usg-kpn-ftth/assets/css/post.css"><link rel="preload" as="style" href="/usg-kpn-ftth/assets/css/lib/bootstrap-toc.min.css"><link rel="stylesheet" href="/usg-kpn-ftth/assets/css/lib/bootstrap-toc.min.css" /> <script src="https://cdn.jsdelivr.net/npm/jquery@3/dist/jquery.min.js"></script> <script defer src="https://cdn.jsdelivr.net/combine/npm/popper.js@1.15.0,npm/bootstrap@4/dist/js/bootstrap.min.js"></script> <script async src="/usg-kpn-ftth/assets/js/post.min.js"></script> <script defer src="/usg-kpn-ftth/app.js"></script> <script defer src="https://www.googletagmanager.com/gtag/js?id=UA-4456753-2"></script> <script> document.addEventListener("DOMContentLoaded", function(event) { window.dataLayer = window.dataLayer || []; function gtag(){dataLayer.push(arguments);} gtag('js', new Date()); gtag('config', 'UA-4456753-2'); }); </script><body data-spy="scroll" data-target="#toc"><div id="sidebar" class="d-flex flex-column align-items-end"><div class="profile-wrapper text-center"><div id="avatar"> <a href="/usg-kpn-ftth/" alt="avatar" class="mx-auto"> <img src="/usg-kpn-ftth/assets/img/sample/avatar.jpg" alt="avatar" onerror="this.style.display='none'"> </a></div><div class="site-title mt-3"> <a href="/usg-kpn-ftth/">USG en KPN</a></div><div class="site-subtitle font-italic">Een avontuur met KPN en de USG in de hoofdrol</div></div><ul class="w-100"><li class="nav-item"> <a href="/usg-kpn-ftth/" class="nav-link"> <i class="fa-fw fas fa-home ml-xl-3 mr-xl-3 unloaded"></i> <span>HOME</span> </a><li class="nav-item"> <a href="/usg-kpn-ftth/tabs/categories/" class="nav-link"> <i class="fa-fw fas fa-stream ml-xl-3 mr-xl-3 unloaded"></i> <span>CATEGORIES</span> </a><li class="nav-item"> <a href="/usg-kpn-ftth/tabs/tags/" class="nav-link"> <i class="fa-fw fas fa-tags ml-xl-3 mr-xl-3 unloaded"></i> <span>TAGS</span> </a><li class="nav-item"> <a href="/usg-kpn-ftth/tabs/archives/" class="nav-link"> <i class="fa-fw fas fa-archive ml-xl-3 mr-xl-3 unloaded"></i> <span>ARCHIVES</span> </a><li class="nav-item"> <a href="/usg-kpn-ftth/tabs/about/" class="nav-link"> <i class="fa-fw fas fa-info ml-xl-3 mr-xl-3 unloaded"></i> <span>ABOUT</span> </a></ul><div class="sidebar-bottom mt-auto d-flex flex-wrap justify-content-center"> <a href="https://github.com/coolhva" aria-label="github" class="order-3" target="_blank" rel="noopener"> <i class="fab fa-github-alt"></i> </a> <a href="https://twitter.com/coolhva" aria-label="twitter" class="order-4" target="_blank" rel="noopener"> <i class="fab fa-twitter"></i> </a> <a href=" javascript:location.href = 'mailto:' + ['henk','vanachterberg.org'].join('@')" aria-label="email" class="order-5" > <i class="fas fa-envelope"></i> </a> <a href="/usg-kpn-ftth/feed.xml" aria-label="rss" class="order-6" > <i class="fas fa-rss"></i> </a> <span class="icon-border order-2"></span> <span id="mode-toggle-wrapper" class="order-1"> <i class="mode-toggle fas fa-adjust"></i> <script type="text/javascript"> class ModeToggle { static get MODE_KEY() { return "mode"; } static get DARK_MODE() { return "dark"; } static get LIGHT_MODE() { return "light"; } constructor() { if (this.hasMode) { if (this.isDarkMode) { if (!this.isSysDarkPrefer) { this.setDark(); } } else { if (this.isSysDarkPrefer) { this.setLight(); } } } var self = this; /* always follow the system prefers */ this.sysDarkPrefers.addListener(function() { if (self.hasMode) { if (self.isDarkMode) { if (!self.isSysDarkPrefer) { self.setDark(); } } else { if (self.isSysDarkPrefer) { self.setLight(); } } self.clearMode(); } self.updateMermaid(); }); } /* constructor() */ setDark() { $('html').attr(ModeToggle.MODE_KEY, ModeToggle.DARK_MODE); sessionStorage.setItem(ModeToggle.MODE_KEY, ModeToggle.DARK_MODE); } setLight() { $('html').attr(ModeToggle.MODE_KEY, ModeToggle.LIGHT_MODE); sessionStorage.setItem(ModeToggle.MODE_KEY, ModeToggle.LIGHT_MODE); } clearMode() { $('html').removeAttr(ModeToggle.MODE_KEY); sessionStorage.removeItem(ModeToggle.MODE_KEY); } get sysDarkPrefers() { return window.matchMedia("(prefers-color-scheme: dark)"); } get isSysDarkPrefer() { return this.sysDarkPrefers.matches; } get isDarkMode() { return this.mode == ModeToggle.DARK_MODE; } get isLightMode() { return this.mode == ModeToggle.LIGHT_MODE; } get hasMode() { return this.mode != null; } get mode() { return sessionStorage.getItem(ModeToggle.MODE_KEY); } /* get the current mode on screen */ get modeStatus() { if (this.isDarkMode || (!this.hasMode && this.isSysDarkPrefer) ) { return ModeToggle.DARK_MODE; } else { return ModeToggle.LIGHT_MODE; } } updateMermaid() { if (typeof mermaid !== "undefined") { let expectedTheme = (this.modeStatus === ModeToggle.DARK_MODE? "dark" : "default"); let config = { theme: expectedTheme }; /* re-render the SVG â€º <https://github.com/mermaid-js/mermaid/issues/311#issuecomment-332557344> */ $(".mermaid").each(function() { let svgCode = $(this).prev().children().html(); $(this).removeAttr("data-processed"); $(this).html(svgCode); }); mermaid.initialize(config); mermaid.init(undefined, ".mermaid"); } } flipMode() { if (this.hasMode) { if (this.isSysDarkPrefer) { if (this.isLightMode) { this.clearMode(); } else { this.setLight(); } } else { if (this.isDarkMode) { this.clearMode(); } else { this.setDark(); } } } else { if (this.isSysDarkPrefer) { this.setLight(); } else { this.setDark(); } } this.updateMermaid(); } /* flipMode() */ } /* ModeToggle */ let toggle = new ModeToggle(); $(".mode-toggle").click(function() { toggle.flipMode(); }); </script> </span></div></div><div id="topbar-wrapper" class="row justify-content-center topbar-down"><div id="topbar" class="col-11 d-flex h-100 align-items-center justify-content-between"> <span id="breadcrumb"> <span> <a href="/usg-kpn-ftth/"> Posts </a> </span> <span>Unifi Security Gateway (USG) met KPN L2TP VPN</span> </span> <i id="sidebar-trigger" class="fas fa-bars fa-fw"></i><div id="topbar-title"> Post</div><i id="search-trigger" class="fas fa-search fa-fw"></i> <span id="search-wrapper" class="align-items-center"> <i class="fas fa-search fa-fw"></i> <input class="form-control" id="search-input" type="search" aria-label="search" placeholder="Search..."> <i class="fa fa-times-circle fa-fw" id="search-cleaner"></i> </span> <span id="search-cancel" >Cancel</span></div></div><div id="main-wrapper"><div id="main"><div class="row"><div id="post-wrapper" class="col-12 col-lg-11 col-xl-8"><div class="post pl-1 pr-1 pl-sm-2 pr-sm-2 pl-md-4 pr-md-4"><h1 data-toc-skip>Unifi Security Gateway (USG) met KPN L2TP VPN</h1><div class="post-meta text-muted d-flex flex-column"><div> <span class="timeago " data-toggle="tooltip" data-placement="bottom" title="Mon, Jan 18, 2021, 3:00 PM +0100" > Jan 18 <i class="unloaded">2021-01-18T15:00:00+01:00</i> </span> by <span class="author"> Henk van Achterberg </span></div><div> <span> Updated <span class="timeago lastmod" data-toggle="tooltip" data-placement="bottom" title="Sat, Jan 30, 2021, 12:31 AM +0100" > Jan 30 <i class="unloaded">2021-01-30T00:31:24+01:00</i> </span> </span> <span class="readtime" data-toggle="tooltip" data-placement="bottom" title="1672 words">9 min</span></div></div><div class="post-content"><h2 id="inleiding">Inleiding</h2><p>Deze handleiding neem ik je mee hoe je met een L2TP VPN van buitenaf verbinding kan maken met de USG op je KPN FttH aansluiting. Deze handleiding is alleen van toepassing indien je ook IPTV hebt geconfigureerd via <a href="/usg-kpn-ftth/posts/unifi-security-gateway-kpn-ftth-iptv-ipv6/index.html">deze</a> handleiding waarin we de USG rechtstreeks aansluiten op de FTTH verbinding van KPN.</p><h3 id="wat-is-een-l2tp-vpn">Wat is een L2TP VPN?</h3><p>Met een VPN (Virtual Private Network) maak je een verbinding vanaf, bijvoorbeeld, je telefoon of laptop via het internet met je USG. Nadat je inloggegevens zijn gecontroleerd is je telefoon of laptop onderdeel van het VPN netwerk op de USG. Vanuit dit VPN netwerk kan je telefoon of laptop apparaten bereiken op je andere interne netwerk(en) of het internet bereiken via de USG waardoor het lijkt alsof je vanaf je thuis netwerk het internet op gaat.</p><h2 id="voorbereiding">Voorbereiding</h2><p>Voordat we daadwerkelijk gaan beginnen is het belangrijk om een aantal zaken voor te bereiden.</p><h3 id="hardware">Hardware</h3><p>De volgende hardware hebben we nodig om deze handleiding te kunnen voltooien.</p><div class="table-wrapper"><table><thead><tr><th style="text-align: left">Type<th style="text-align: left">Merk<th style="text-align: left">Omschrijving<tbody><tr><td style="text-align: left">USGÂ Router<td style="text-align: left">Ubiquiti<td style="text-align: left">Dit is de Ubiquiti Unifi security gateway (USG) die internet en IPTV verzorgt.<tr><td style="text-align: left">UnifiÂ controller<td style="text-align: left">Ubiquiti / anders<td style="text-align: left">Met de controller stel je de USG in, deze kan op een stuk hardware (cloudkey) draaien maar ook op je computer, server, NAS rechstreeks of bijvoorbeeld via docker.<tr><td style="text-align: left">VPN Client<td style="text-align: left">Telefoon/Laptop<td style="text-align: left">Een apparaat wat L2TP VPN ondersteuning heeft (Andriod, IOS, Mac (OSX) of Windows) en de mogelijkheid om dit te testen buiten je eigen internet verbinding om, bijvoorbeeld via 4G of WiFi van de buren.</table></div><blockquote><p><strong><em>Let op:</em></strong> deze handleiding is bedoeld voor een Ubiquity Unifi Security Gateway 3. Indien je een USG 4 Pro hebt dien je in de setvpn.sh de interfaces aan te passen op de manier waarop je je USG 4 Pro hebt aangesloten. Bij de USG 3 is eth0 WAN en eth1 LAN.</p></blockquote><h3 id="software">Software</h3><p>In deze handleiding ga ik er vanuit dat we Windows 10 gebruiken waarbij we onderstaande software gaan gebruiken. Graag deze bestanden downloaden zodat ze klaar staan als we gaan beginnen.</p><div class="table-wrapper"><table><thead><tr><th style="text-align: left">Software<th style="text-align: left">Omschrijving<tbody><tr><td style="text-align: left"><a href="https://www.chiark.greenend.org.uk/~sgtatham/putty/latest.html" target="_blank">putty.exeÂ (64â€‘bit)</a><td style="text-align: left">Met dit programma kunnen we via SSH inloggen op de USG en eventueel de controller om commandoâ€™s uit te voeren.<tr><td style="text-align: left"><a href="https://winscp.net/eng/downloads.php" target="_blank">WinSCPÂ Portable</a><td style="text-align: left">WinSCP gebruiken we om via Secure Copy Protocol bestanden van onze computer naar de USG en eventueel de controller te krijgen.<tr><td style="text-align: left"><a href="https://github.com/coolhva/usg-kpn-ftth/archive/vpn.zip" target="_blank">usg-kpn-ftth-vpn zip</a><td style="text-align: left">De inhoud van mijn github repo met VPN ondersteuning in zip formaat zodat we alle bestanden in het juiste (UNIX) formaat hebben. Deze gaan we later naar de juiste locaties (Controller) verplaatsen.</table></div><h3 id="gegevens">Gegevens</h3><p>Onderstaande informatie gaan we gebruiken in deze handleiding.</p><div class="table-wrapper"><table><thead><tr><th style="text-align: left">Informatie<th style="text-align: left">Omschrijving<tbody><tr><td style="text-align: left">Extern IPv4 adres<td style="text-align: left">Dit is het IPv4 adres van je KPN aansluiting, dit kan je achterhalen om via je KPN verbinding naar bijvoorbeeld <a href="https://test-ipv6.com/">test-ipv6.com</a> te gaan. <img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-src="/usg-kpn-ftth/assets/img/usgkpnvpn/usg_vpn_get_remote_ip.png" alt="get_ip_address" /><tr><td style="text-align: left">URLÂ Controller<td style="text-align: left">Dit is het web adres waarop de unifi controller bereikbaar is, deze is bereikbaar op een IP adres en draait vaak op poort 8443 (HTTPS).<tr><td style="text-align: left">ControllerÂ login<td style="text-align: left">De gebruikersnaam en wachtwoord om in te kunnen loggen op de controller.<tr><td style="text-align: left">SSHÂ loginÂ gegevens USG<td style="text-align: left">De gebruikersnaam en wachtwoord om via SSH in te kunnen loggen op de USG (zie kopje hieronder).</table></div><h3 id="ssh-toegang-unifi-apparaten">SSH toegang unifi apparaten</h3><p>Om toegang te krijgen tot de USG via SSH moet dit geconfigureerd zijn. In de webinterface van de controller ga je naar <kbd>settings</kbd> en dan naar <kbd>Controller Configuration</kbd> en scroll je naar beneden naar <kbd>Element SSH Authentication</kbd>. Hier vink je <kbd>Element SSH authentication</kbd> aan en kies je een gebruikersnaam en wachtwoord. Daarna klik je op <kbd>Apply Changes</kbd>. Vanaf nu kan je met deze gebruikersnaam en wachtwoord via SSH inloggen op de USG.</p><p><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-src="/usg-kpn-ftth/assets/img/usgkpn/unifi_controller_ssh.png" alt="unifi_controller_ssh" /></p><h2 id="uitgangssituatie">Uitgangssituatie</h2><p>Voordat we beginnen moeten we eerst weten waar we starten. In deze handleiding starten we met het volgende:</p><ol><li>De USG zit met de WAN aansluiting direct aangesloten aan de NTU van KPN met een ethernet (UTP) kabel.<li>De LAN aansluiting van de USG zit met een ethernet (UTP) kabel verbonden met een switch.<br /> Dat kan een unifi switch zijn maar mag ook een ander merk zijn, wel moet IGMP en VLAN ondersteund worden.<li>Op de switch (direct of via een andere switch), zit de unifi controller verbonden.<br /> Dit kan een unifi cloud key zijn maar ook een computer, server of een NAS.<li>Ook zit de IPTV setupbox van KPN via een ethernet kabel verbonden aan een switch met IGMP en VLAN ondersteuning.<li>Deze handleiding (<a href="/usg-kpn-ftth/posts/unifi-security-gateway-kpn-ftth-iptv-ipv6/index.html">link</a>) is uitgevoerd en TV en internet werkt op dit moment.<li><code class="language-plaintext highlighter-rouge">[Optioneel]</code> De IPTV kastjes zitten in hun eigen VLAN door middel van deze handleiding <a href="/usg-kpn-ftth/posts/unifi-security-gateway-kpn-iptv-vlan/index.html">link</a>.</ol><p>Als we de bestanden hebben gedownload pakken we de twee zip bestanden (winscp en usg-kpn-ftth vpn.zip) uit zodat we een map met WinSCP, een map met de configuratie bestanden en als laatst putty.exe hebben.</p><p><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-src="/usg-kpn-ftth/assets/img/usgkpnvpn/usg_vpn_files.png" alt="files_downloaded" /></p><h2 id="oude-interface-inschakelen">Oude interface inschakelen</h2><p>Er is, helaas, een fout in de software van de Unifi controller geslopen waardoor je de VPN verbinding alleen succesvol kan instellen als je de oude interface gebruikt. Ga via <kbd>Settings</kbd> naar <kbd>System Settings</kbd> en schakel <kbd>New Settings</kbd> uit. Klik nu op <kbd>Apply Changes</kbd>.</p><p><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-src="/usg-kpn-ftth/assets/img/usgkpnvpn/usg_vpn_use_old_settings.png" alt="old_interface" /></p><h2 id="radius-server-inschakelen">Radius server inschakelen</h2><p>We gaan de radius server inschakelen, welke verantwoordelijk is voor het controleren van de inloggegevens. Ga naar <kbd>Settings</kbd>, klik op <kbd>Services</kbd>, <kbd>Radius</kbd> en daarna op <kbd>Server</kbd>. Schakel de <kbd>Enable RADIUS Server</kbd> naar <kbd>ON</kbd>, vul een <kbd>Secret</kbd> in (kies hier een wachtwoord wat intern in de USG zal worden gebruikt om te communiceren met de Radius server) en klik op <kbd>Apply Changes</kbd>.</p><p><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-src="/usg-kpn-ftth/assets/img/usgkpnvpn/usg_vpn_services_enable_radius.png" alt="enable_radius" /></p><p>Klik nu op de <kbd>Users</kbd> tab en klik op <kbd>+ Create New User</kbd>.</p><p><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-src="/usg-kpn-ftth/assets/img/usgkpnvpn/usg_vpn_users.png" alt="radius_users" /></p><p>Vul bij <kbd>Name</kbd> een gebruikersnaam en bij <kbd>Password</kbd> een wachtwoord in. Deze gegevens zal je ook moeten invullen in de VPN client om verbinding te maken met de USG. Laat <kbd>VLAN</kbd> leeg, kies bij <kbd>Tunnel Type</kbd> voor <kbd>3&nbsp;-&nbsp;Layer&nbsp;Two&nbsp;Tunneling&nbsp;Protocol&nbsp;(L2TP)</kbd> en bij <kbd>Tunnel Medium Type</kbd> voor <kbd>1&nbsp;-&nbsp;IPv4&nbsp;(IP&nbsp;version&nbsp;4)</kbd>. Klik nu op <kbd>Save</kbd>.</p><p><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-src="/usg-kpn-ftth/assets/img/usgkpnvpn/usg_vpn_create_user.png" alt="radius_create_user" /></p><h2 id="vpn-netwerk-aanmaken">VPN Netwerk aanmaken</h2><p>Nadat we de Radius server hebben ingeschakeld en een gebruiker hebben aangemaakt gaan we nu een VPN Netwerk toevoegen waar VPN gebruikers onderdeel van worden zodra ze via VPN verbinding maken met de USG.</p><p>Ga via <kbd>Settings</kbd> naar <kbd>Networks</kbd> en klik op <kbd>+ Create New Network</kbd>.</p><p><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-src="/usg-kpn-ftth/assets/img/usgkpnvpn/usg_vpn_networks_without_vpn.png" alt="networks_without_vpn" /></p><p>Maak een nieuw VPN netwerk met de volgende gegevens:</p><div class="table-wrapper"><table><thead><tr><th style="text-align: left">Omschrijving<th style="text-align: left">Keuze<tbody><tr><td style="text-align: left">Name<td style="text-align: left">Kies een naam voor het VPN netwerk, bijvoorbeeld VPN.<tr><td style="text-align: left">Purpose<td style="text-align: left">Remote User VPN<tr><td style="text-align: left">VPN Type<td style="text-align: left">L2TP Server<tr><td style="text-align: left">Pre-Shared Key<td style="text-align: left">Kies een wachtwoord, dit wachtwoord moet je straks ook invullen in je VPN client.<tr><td style="text-align: left">GatewayÂ IP/Subnet<td style="text-align: left">Vul hier 100.64.64.64/24 in, deze ip reeks is speciaal<sup id="fnref:fn-ip100-64" role="doc-noteref"><a href="#fn:fn-ip100-64" class="footnote">1</a></sup> en wordt niet intern gebruikt en zorgt dat je geen IP conflict krijgt.<tr><td style="text-align: left">Name Server<td style="text-align: left">Auto<tr><td style="text-align: left">WINS Server<td style="text-align: left">Uitgevinkt<tr><td style="text-align: left">Site-to-Site VPN<td style="text-align: left">Uitgevinkt<tr><td style="text-align: left">RADIUS Profile<td style="text-align: left">Default<tr><td style="text-align: left">MS-CHAP v2<td style="text-align: left">Uitgevinkt</table></div><p>Klik nu op <kbd>Save</kbd>.</p><p><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-src="/usg-kpn-ftth/assets/img/usgkpnvpn/usg_vpn_create_network.png" alt="create_vpn_network" /></p><p>In de lijst met netwerken moet het nieuw aangemaakte VPN netwerk er nu bij staan.</p><p><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-src="/usg-kpn-ftth/assets/img/usgkpnvpn/usg_networks_with_vpn.png" alt="networks_with_vpn" /></p><h2 id="wan-netwerk-controleren">WAN Netwerk controleren</h2><p>Het is belangrijk om te zorgen dat het WAN netwerk niet is geconfigureerd en dat <kbd>Use VLAN ID</kbd> is uitgevinkt. Het WAN netwerk wordt namelijk via de config.gateway.json geconfigureerd en ook setvpn.sh gaat er vanuit dat het WAN netwerk als volgt is ingesteld. Je kan deze instellingen bereiken door via <kbd>Settings</kbd> naar <kbd>Networks</kbd> te gaan en dan te kiezen voor <kbd>Edit</kbd> bij het <kbd>WAN</kbd> netwerk.</p><p><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-src="/usg-kpn-ftth/assets/img/usgkpnvpn/usg_vpn_wan.png" alt="networks_wan" /></p><h2 id="setvpnsh-plaatsen">Setvpn.sh plaatsen</h2><p>Start WinSCP en klik in WinSCP op de knop <kbd>New Session</kbd> en vul de gegevens in van de USG. De eventuele waarschuwing van unkown server beantwoordt je met <kbd>Yes</kbd>. Een popup met een welkomstboodschap verschijnt en hier mag je op <kbd>Continue</kbd> klikken.</p><p><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-src="/usg-kpn-ftth/assets/img/usgkpn/winscp_usg.png" alt="winscp_usg" /></p><p>Nadat de verbinding tot stand is gekomen navigeren we in het rechter venster naar de locatie <code class="language-plaintext highlighter-rouge">/config/scripts/post-config.d</code>. In het linker scherm selecteren we setvpn.sh en klikken we weer op de knop <kbd>Upload</kbd>. Klik hierna op <kbd>Ok</kbd> en daarna is het bestand op de USG geplaatst.</p><p><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-src="/usg-kpn-ftth/assets/img/usgkpnvpn/usg_vpn_transfer_file.png" alt="winscp_usg_upload" /></p><p>Nu moeten we het bestand uitvoerbaar maken. Dat doen we door de het bestand te selecteren en daarna met de rechtermuisknop er op te klikken en voor <kbd>Properties</kbd> te kiezen.</p><p><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-src="/usg-kpn-ftth/assets/img/usgkpnvpn/usg_vpn_setvpn_properties.png" alt="winscp_usg_select" /></p><p>In de eigenschappen mag je een vinkje zetten bij elke <kbd>X</kbd> (bij <kbd>Octal</kbd> komt nu <kbd>0755</kbd> te staan) en daarna op <kbd>Ok</kbd> klikken.</p><p><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-src="/usg-kpn-ftth/assets/img/usgkpnvpn/usg_vpn_setvpn_chmod_755.png" alt="winscp_usg_chmod" /></p><p>Nu mag je WinSCP sluiten en in de controller naar <kbd>Devices</kbd> gaan. Ga met de muis op de regel van de USG staan, rechts verschijnt de herstart optie en dan klik je op <kbd>Restart</kbd>.</p><p><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-src="/usg-kpn-ftth/assets/img/usgkpnvpn/usg_vpn_restart.png" alt="unifi_controller_usg_restart" /></p><p>Na de herstart worden de VPN instellingen geactiveerd en kunnen we nu de VPN gaan testen.</p><h2 id="vpn-testen">VPN Testen</h2><p>In dit voorbeeld pak ik een iPhone maar dezelfde logica kan worden gebruikt op een Android telefoon of laptop.</p><p>Ga op de iPhone naar <kbd>Settings</kbd> en daarna naar <kbd>VPN</kbd>. Kies voor <kbd>Add VPN Configuration...</kbd>.</p><p><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-src="/usg-kpn-ftth/assets/img/usgkpnvpn/ios_settings_vpn.png" alt="ios_settings_vpn" width="500" /></p><p>Vul de volgende gegevens in:</p><div class="table-wrapper"><table><thead><tr><th style="text-align: left">Omschrijving<th style="text-align: left">Keuze<tbody><tr><td style="text-align: left">Type<td style="text-align: left">L2TP<tr><td style="text-align: left">Description<td style="text-align: left">Kies een naam voor het VPN verbinding, bijvoorbeeld Thuis.<tr><td style="text-align: left">Server<td style="text-align: left">Het externe IPv4 adres van je KPN internet verbinding.<tr><td style="text-align: left">Account<td style="text-align: left">De gebruikersnaam die je in de Radius configuratie hebt aangemaakt.<tr><td style="text-align: left">RSA SecurID<td style="text-align: left">Uitgeschakeld<tr><td style="text-align: left">Password<td style="text-align: left">Het wachtwoord die je hebt gebruikt bij het aanmaken van de gebruiker in de Radius configuratie.<tr><td style="text-align: left">Secret<td style="text-align: left">Vul hier de <kbd>Pre-Shared Key</kbd> in die je bij het aanmaken van het VPN netwerk hebt gekozen.<tr><td style="text-align: left">Send All Traffic<td style="text-align: left">Ja. Aangezien het L2TP protocol geen voorziening heeft om aan te geven welke netwerken via de VPN moeten lopen moet al het verkeer via de VPN lopen wil je toegang krijgen tot apparaten in je eigen netwerk(en).<tr><td style="text-align: left">Proxy<td style="text-align: left">Off</table></div><p>Kies daarna op <kbd>Done</kbd>.</p><p><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-src="/usg-kpn-ftth/assets/img/usgkpnvpn/ios_settings_vpn_create.png" alt="ios_vpn_create" width="500" /></p><p>In het overzicht is de VPN verbinding er nu bijgekomen. Selecteer deze verbinding en zorg dat je verbonden bent via een ander netwerk dan je eigen KPN internet verbinding (bijvoorbeeld via 4G of WiFi van je buren).</p><p><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-src="/usg-kpn-ftth/assets/img/usgkpnvpn/ios_settings_vpn_created.png" alt="ios_vpn_created" width="500" /></p><p>Zet nu de VPN verbinding aan door de knop om te zetten in de <kbd>Status</kbd> regel. Als alles goed gaat zal je nu zien dat je verbonden bent.</p><p><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-src="/usg-kpn-ftth/assets/img/usgkpnvpn/ios_settings_vpn_connected.png" alt="ios_vpn_connected" width="500" /></p><p>Je kan nu naar je webbrowser gaan en in google vragen naar <kbd>what is my ip</kbd>. Als resultaat zie je het IPv4 adres waar Google ziet waar je vandaan komt. Dit is, als je al het verkeer doorstuurt naar de USG, het IPv4 adres van je KPN Internet verbinding.</p><p><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-src="/usg-kpn-ftth/assets/img/usgkpnvpn/ios_vpn_external_ip.png" alt="ios_vpn_external_ip" width="500" /></p><p>Ook kan je nu verbinding maken met apparaten in je eigen netwerk, hieronder een voorbeeld van de login pagina van de unifi controller op mijn interne netwerk.</p><p><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-src="/usg-kpn-ftth/assets/img/usgkpnvpn/ios_vpn_internal_server.png" alt="ios_vpn_interal_server" width="500" /></p><blockquote><p>Indien je me wilt bedanken (hoeft niet, mag wel) dan kan dat via <a href="https://www.buymeacoffee.com/coolhva">Buymeacoffee</a>.</p></blockquote><div class="footnotes" role="doc-endnotes"><ol><li id="fn:fn-ip100-64" role="doc-endnote"><p>100.64.0.0/10 Reserved IP Space, CGN: <a href="https://en.wikipedia.org/wiki/IPv4_shared_address_space">Wikipedia</a>Â <a href="#fnref:fn-ip100-64" class="reversefootnote" role="doc-backlink">&#8617;</a></p></ol></div></div><div class="post-tail-wrapper text-muted"><div class="post-meta mb-3"> <i class="far fa-folder-open fa-fw mr-1"></i> <a href='/usg-kpn-ftth/categories/documentatie/'>Documentatie</a>, <a href='/usg-kpn-ftth/categories/handleiding/'>Handleiding</a></div><div class="post-tags"> <i class="fa fa-tags fa-fw mr-1"></i> <a href="/usg-kpn-ftth/tags/usg/" class="post-tag no-text-decoration" >usg</a> <a href="/usg-kpn-ftth/tags/unifi/" class="post-tag no-text-decoration" >unifi</a> <a href="/usg-kpn-ftth/tags/vpn/" class="post-tag no-text-decoration" >vpn</a></div><div class="post-tail-bottom d-flex justify-content-between align-items-center mt-3 pt-5 pb-2"><div class="license-wrapper"> This post is licensed under <a href="https://creativecommons.org/licenses/by/4.0/">CC BY 4.0</a> by the author.</div><div class="share-wrapper"> <span class="share-label text-muted mr-1">Share</span> <span class="share-icons"> <a href="https://twitter.com/intent/tweet?text=Unifi Security Gateway (USG) met KPN L2TP VPN - USG en KPN&url=https://www.vanachterberg.org/usg-kpn-ftth/posts/unifi-security-gateway-kpn-l2tp-vpn/" data-toggle="tooltip" data-placement="top" title="Twitter" target="_blank" rel="noopener" aria-label="Twitter"> <i class="fa-fw fab fa-twitter"></i> </a> <a href="https://www.facebook.com/sharer/sharer.php?title=Unifi Security Gateway (USG) met KPN L2TP VPN - USG en KPN&u=https://www.vanachterberg.org/usg-kpn-ftth/posts/unifi-security-gateway-kpn-l2tp-vpn/" data-toggle="tooltip" data-placement="top" title="Facebook" target="_blank" rel="noopener" aria-label="Facebook"> <i class="fa-fw fab fa-facebook-square"></i> </a> <a href="https://telegram.me/share?text=Unifi Security Gateway (USG) met KPN L2TP VPN - USG en KPN&url=https://www.vanachterberg.org/usg-kpn-ftth/posts/unifi-security-gateway-kpn-l2tp-vpn/" data-toggle="tooltip" data-placement="top" title="Telegram" target="_blank" rel="noopener" aria-label="Telegram"> <i class="fa-fw fab fa-telegram"></i> </a> <i class="fa-fw fas fa-link small" onclick="copyLink()" data-toggle="tooltip" data-placement="top" title="Copy link"></i> </span></div></div></div></div></div><div id="panel-wrapper" class="col-xl-3 pl-2 text-muted topbar-down"><div class="access"><div id="access-lastmod" class="post"> <span>Recent Update</span><ul class="post-content pl-0 pb-1 ml-1 mt-2"><li><a href="/usg-kpn-ftth/posts/unifi-security-gateway-kpn-iptv-vlan/">Unifi Security Gateway (USG) met KPN IPTV op een apart VLAN</a><li><a href="/usg-kpn-ftth/posts/unifi-security-gateway-kpn-l2tp-vpn/">Unifi Security Gateway (USG) met KPN L2TP VPN</a><li><a href="/usg-kpn-ftth/posts/unifi-security-gateway-kpn-ftth-iptv-ipv6/">Unifi Security Gateway (USG) installeren met KPN FTTH inclusief IPTV en IPv6</a><li><a href="/usg-kpn-ftth/posts/unifi-security-gateway-sides-folder/">De sites/default map aanmaken op de Unifi controller</a></ul></div><div id="access-tags"> <span>Trending Tags</span><div class="d-flex flex-wrap mt-3 mb-1 mr-3"> <a class="post-tag" href="/usg-kpn-ftth/tags/unifi/">unifi</a> <a class="post-tag" href="/usg-kpn-ftth/tags/usg/">usg</a> <a class="post-tag" href="/usg-kpn-ftth/tags/vpn/">vpn</a></div></div></div><div id="toc-wrapper" class="pl-0 pr-4 mb-5"> <span class="pl-3 pt-2 mb-2">Contents</span><nav id="toc" data-toggle="toc"></nav></div></div></div><div class="row"><div class="col-12 col-lg-11 col-xl-8"><div id="post-extend-wrapper" class="pl-1 pr-1 pl-sm-2 pr-sm-2 pl-md-4 pr-md-4"><div id="related-posts" class="mt-5 mb-2 mb-sm-4"><h3 class="pt-2 mt-1 mb-4 ml-1" data-toc-skip>Further Reading</h3><div class="card-deck mb-4"><div class="card"> <a href="/usg-kpn-ftth/posts/unifi-security-gateway-kpn-ftth-iptv-ipv6/"><div class="card-body"> <span class="timeago small" > Dec 31, 2019 <i class="unloaded">2019-12-31T15:00:00+01:00</i> </span><h3 class="pt-0 mt-1 mb-3" data-toc-skip>Unifi Security Gateway (USG) installeren met KPN FTTH inclusief IPTV en IPv6</h3><div class="text-muted small"><p> Inleiding In deze handleiding neem ik je mee hoe je een Unifi Security Gateway (USG) rechtstreeks kan aansluiten op glasvezel (FTTH) van KPN en daarbij gebruik kan maken van de IPTV kastjes die do...</p></div></div></a></div><div class="card"> <a href="/usg-kpn-ftth/posts/unifi-security-gateway-kpn-iptv-vlan/"><div class="card-body"> <span class="timeago small" > Dec 8, 2020 <i class="unloaded">2020-12-08T15:00:00+01:00</i> </span><h3 class="pt-0 mt-1 mb-3" data-toc-skip>Unifi Security Gateway (USG) met KPN IPTV op een apart VLAN</h3><div class="text-muted small"><p> Inleiding Deze handleiding neem ik je mee hoe je de IPTV kastjes van KPN achter de USG in hun eigen netwerk (VLAN) zet zodat de kans op verstoring kleiner is. Deze handleiding borduurt verder op d...</p></div></div></a></div><div class="card"> <a href="/usg-kpn-ftth/posts/unifi-security-gateway-sides-folder/"><div class="card-body"> <span class="timeago small" > Dec 28, 2020 <i class="unloaded">2020-12-28T15:00:00+01:00</i> </span><h3 class="pt-0 mt-1 mb-3" data-toc-skip>De sites/default map aanmaken op de Unifi controller</h3><div class="text-muted small"><p> Inleiding In de handleidingen op deze site wordt er gevraagd om een json configuratie bestand in een bepaalde map (sites/default) neer te zetten. Mocht je een eigen site hebben aangemaakt dan zal ...</p></div></div></a></div></div></div><div class="post-navigation d-flex justify-content-between"> <a href="/usg-kpn-ftth/posts/unifi-security-gateway-sides-folder/" class="btn btn-outline-primary"><p>De sites/default map aanmaken op de Unifi controller</p></a> <span class="btn btn-outline-primary disabled"><p>-</p></span></div><div id="disqus" class="pt-2 pb-2"><p class="font-italic text-center text-muted small"> Comments powered by <a href="https://disqus.com/">Disqus</a>.</p></div><script src="/usg-kpn-ftth/assets/js/lib/jquery.disqusloader.min.js"></script> <script> var options = { scriptUrl: '//coolhva-usg-kpn.disqus.com/embed.js', disqusConfig: function() { this.page.url = 'https://www.vanachterberg.org/usg-kpn-ftth/posts/unifi-security-gateway-kpn-l2tp-vpn/'; this.page.identifier = '/posts/unifi-security-gateway-kpn-l2tp-vpn/'; } }; $.disqusLoader('#disqus', options); </script></div></div></div><script type="text/javascript" src="https://cdn.jsdelivr.net/npm/lozad/dist/lozad.min.js"></script> <script type="text/javascript"> const imgs = document.querySelectorAll('#post-wrapper img'); const observer = lozad(imgs); observer.observe(); </script><footer class="d-flex w-100 justify-content-center"><div class="d-flex justify-content-between align-items-center"><div class="footer-left"><p class="mb-0"> Â© 2021 <a href="https://twitter.com/coolhva">Henk van Achterberg</a>. <span data-toggle="tooltip" data-placement="top" title="Except where otherwise noted, the blog posts on this site are licensed under the Creative Commons Attribution 4.0 International (CC BY 4.0) License by the author.">Some rights reserved.</span></p></div><div class="footer-right"><p class="mb-0"> Powered by <a href="https://jekyllrb.com" target="_blank" rel="noopener">Jekyll</a> with <a href="https://github.com/cotes2020/jekyll-theme-chirpy/" target="_blank" rel="noopener">Chirpy</a> theme.</p></div></div></footer></div><div id="search-result-wrapper" class="d-flex justify-content-center unloaded"><div class="col-12 col-xl-11 post-content"><div id="search-hints"><h4 class="text-muted mb-4">Trending Tags</h4><a class="post-tag" href="/usg-kpn-ftth/tags/unifi/">unifi</a> <a class="post-tag" href="/usg-kpn-ftth/tags/usg/">usg</a> <a class="post-tag" href="/usg-kpn-ftth/tags/vpn/">vpn</a></div><div id="search-results" class="d-flex flex-wrap justify-content-center text-muted mt-3"></div></div></div></div><div id="mask"></div><a id="back-to-top" href="#" aria-label="back-to-top" class="btn btn-lg btn-box-shadow" role="button"> <i class="fas fa-angle-up"></i> </a> <script src="https://cdn.jsdelivr.net/npm/simple-jekyll-search@1.7.3/dest/simple-jekyll-search.min.js"></script> <script> SimpleJekyllSearch({ searchInput: document.getElementById('search-input'), resultsContainer: document.getElementById('search-results'), json: '/usg-kpn-ftth/assets/js/data/search.json', searchResultTemplate: '<div class="pl-1 pr-1 pl-sm-2 pr-sm-2 pl-lg-4 pr-lg-4 pl-xl-0 pr-xl-0"> <a href="https://www.vanachterberg.org{url}">{title}</a><div class="post-meta d-flex flex-column flex-sm-row text-muted mt-1 mb-1"><div class="mr-sm-4"><i class="far fa-folder fa-fw"></i>{categories}</div><div><i class="fa fa-tag fa-fw"></i>{tags}</div></div><p>{snippet}</p></div>', noResultsText: '<p class="mt-5">Oops! No result founds.</p>' }); </script>
